{
	servers {
		trusted_proxies static private_ranges
		listener_wrappers {
			# The proxy_protocol wrapper tells Caddy to expect a PROXY header
			# (which carries the real client IP) from upstream proxies.
			proxy_protocol {
				# Set a timeout of 2 seconds for receiving the PROXY header.
				# This ensures that Caddy won’t wait indefinitely if the header isn’t sent.
				timeout 2s

				# Allow connections from the 100.64.0.0/10 IP range.
				# This is typically the range used by the upstream proxy (e.g. FRP server)
				# that sends the correct PROXY header; it prevents headers from untrusted sources.
				# In this case, this includes any address from my tailnet
				allow 100.64.0.0/10

				# Set fallback_policy to "use".
				# With this policy, if a valid PROXY header is present, Caddy will use its values (e.g. the client's real IP).
				# If the header isn’t present, Caddy will simply use the connection’s original remote address.
				# This provides flexibility, ensuring that connections without the header are still processed.
				fallback_policy use
			}
			# The tls wrapper follows, ensuring that after handling the PROXY header,
			# Caddy proceeds with the TLS handshake (i.e. it wraps the connection in TLS).
			tls
		}
	}
}

(security_headers) {
	header {
		X-Robots-Tag "noindex, nofollow"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "no-referrer"
		Strict-Transport-Security "max-age=15552000; includeSubDomains; preload"
		X-XSS-Protection: "1; mode=block"

		# https://www.adobe.com/devnet/adobe-media-server/articles/cross-domain-xml-for-streaming.html
		X-Permitted-Cross-Domain-Policies "none"
	}
}

(is_not_whitelist) {
	not remote_ip private_ranges
	# Allowing Tailscale subnet
	not remote_ip 100.64.0.0/10
}

(restrict_to_lan) {
	@restricted_location {
		path /*
		import is_not_whitelist
	}
	respond @restricted_location "Access Denied" 403 {
		close
	}
}

(sso_if_not_whitelist) {
	@needs_sso {
		import is_not_whitelist
	}

	import geo_allow_eu_and_na

	forward_auth @needs_sso tinyauth:3000 {
		uri /api/auth/caddy
		copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
		trusted_proxies private_ranges
		trusted_proxies 100.64.0.0/10
	}
}

# Rate limit entire site
# Usage: import rate_limit_site <zone_name> <events> <window>
(rate_limit_site) {
	rate_limit {
		zone {args[0]} {
			key {remote_host}
			events {args[1]}
			window {args[2]}
		}
	}
}

# Rate limit specific paths
# Usage: import rate_limit_path <zone_name> <path_glob> <events> <window>
(rate_limit_path) {
	rate_limit {
		zone {args[0]} {
			match {
				path {args[1]}
			}
			key {remote_host}
			events {args[2]}
			window {args[3]}
		}
	}
}


# Block access unless from allowed countries
# Usage: import geo_allow FR DE BE NL
(geo_allow) {
	@blocked_geo {
		not maxmind_geolocation {
			db_path /data/GeoLite2-Country.mmdb
			allow_countries {args[:]}
		}
		# Also allow private/Tailscale ranges (bypass geo check)
		not remote_ip private_ranges
		not remote_ip 100.64.0.0/10
	}
	respond @blocked_geo "Access Denied" 403 {
		close
	}
}

# Continent snippets - expand to country codes
# Usage: import geo_allow_europe
(geo_allow_europe) {
	import geo_allow AT BE BG HR CY CZ DK EE FI FR DE GR HU IE IT LV LT LU MT NL PL PT RO SK SI ES SE GB CH NO IS LI MC AD SM VA
}

(geo_allow_north_america) {
	import geo_allow US CA MX
}


(geo_allow_eu_and_na) {
	import geo_allow AT BE BG HR CY CZ DK EE FI FR DE GR HU IE IT LV LT LU MT NL PL PT RO SK SI ES SE GB CH NO IS US CA
}

cloud.nelyah.eu {
	import security_headers
	import geo_allow_eu_and_na

	import rate_limit_path cloud_login1 /login* 1000 1m
	import rate_limit_path cloud_login2 /index.php/login* 1000 1m


	request_body {
		max_size 5GB
	}

	root * /php-fpm-root/nextcloud/
	file_server
	php_fastcgi nextcloud:9000 {
		root /var/www/html/

		# This is required to inform Nextcloud that it shouldn't be setting
		# headers itself. That's the job of the reverse proxy
		env modHeadersAvailable true
	}

	redir /.well-known/carddav /remote.php/dav 301 permanent
	redir /.well-known/caldav /remote.php/dav 301 permanent

	@forbidden {
		path /.htaccess
		path /data/*
		path /config/*
		path /db_structure
		path /.xml
		path /README
		path /3rdparty/*
		path /lib/*
		path /templates/*
		path /occ
		path /console.php
	}
	respond @forbidden "Access Denied" 403 {
		close
	}
}

chloe.dequeker.me, blog.nelyah.eu {
	import security_headers
	reverse_proxy hugo_website:1313
}

api.blog.nelyah.eu {
	import security_headers

	import sso_if_not_whitelist
	reverse_proxy hugo_website:8000
}

influxdb.nelyah.eu {
	import security_headers
	import sso_if_not_whitelist
	reverse_proxy influxdb:8086
}

music.nelyah.eu {
	import security_headers

	import geo_allow_eu_and_na
	import rate_limit_path navidrome_login /auth/login 1000 1m

	reverse_proxy navidrome
}

prometheus.nelyah.eu {
	import security_headers
	reverse_proxy prometheus:9090
	import sso_if_not_whitelist
}

grafana.nelyah.eu {
	import security_headers
	import sso_if_not_whitelist

	# Actual site configuration below, for example
	reverse_proxy grafana:3000
}

jellyfin.nelyah.eu {
	import security_headers

	import geo_allow_europe
	import rate_limit_path jellyfin_login_name /Users/AuthenticateByName 1000 1m
	import rate_limit_path jellyfin_login_qc /Users/AuthenticateWithQuickConnect 1000 1m
	import rate_limit_path jellyfin_quickconnect /QuickConnect/* 1000 1m

	reverse_proxy jellyfin:8096
}

photos.nelyah.eu, immich.nelyah.eu {
	import security_headers
	reverse_proxy immich_server:2283
}

audiobookshelf.nelyah.eu {
	import security_headers

	import geo_allow_eu_and_na
	import rate_limit_path abs_login /login 1000 1m


	reverse_proxy audiobookshelf
}

pocketid.nelyah.eu {
	import security_headers

	import geo_allow_eu_and_na
	import rate_limit_site pocketid_global 100 1m

	reverse_proxy pocketid:1411
}

tinyauth.nelyah.eu {
	import security_headers

	import geo_allow_eu_and_na
	import rate_limit_site tinyauth_global 1000 1m
	import rate_limit_path tinyauth_oauth_cb /api/oauth/callback/* 1000 1m
	import rate_limit_path tinyauth_login_ui /login* 1000 1m

	reverse_proxy tinyauth:3000
}

vault.nelyah.eu {
	import security_headers
	import sso_if_not_whitelist
	reverse_proxy vault:8200
}

atuin.nelyah.eu {
	import security_headers

	import geo_allow_eu_and_na
	import rate_limit_site atuin_global 100 1m

	reverse_proxy atuin:8888
}

uptime-kuma.nelyah.eu {
	import security_headers
	import sso_if_not_whitelist
	reverse_proxy uptime_kuma:3001
}
